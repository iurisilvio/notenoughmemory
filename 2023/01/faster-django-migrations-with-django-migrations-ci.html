<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Faster Django migrations with django-migrations-ci</title>
        <link rel="stylesheet" href="../../theme/css/main.css" />
        <link href="https://iurisilv.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="iurisilvio Atom Feed" />
        <meta name="description" content="Django migrations are really slow. It is an open issue for years. It was even an Google Summer of Code proposal. For small projects, it take some..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../">iurisilvio</a></h1>
                <nav><ul>
                    <li><a href="../../category/devops.html">devops</a></li>
                    <li><a href="../../category/issue.html">issue</a></li>
                    <li><a href="../../category/misc.html">misc</a></li>
                    <li><a href="../../category/productivity.html">productivity</a></li>
                    <li class="active"><a href="../../category/programming.html">programming</a></li>
                    <li><a href="../../category/stats.html">stats</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../2023/01/faster-django-migrations-with-django-migrations-ci.html" rel="bookmark"
           title="Permalink to Faster Django migrations with django-migrations-ci">Faster Django migrations with django-migrations-ci</a></h1>
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="iurisilvio">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-01-09T00:00:00-03:00">
                Published: Mon 09 January 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../../author/iuri-de-silvio.html">Iuri de Silvio</a>
        </address>
<p>In <a href="../../category/programming.html">programming</a>.</p>
<p>tags: <a href="../../tag/python.html">python</a> <a href="../../tag/django.html">django</a> </p>
</footer><!-- /.post-info -->      <p>Django migrations are really slow. It is an <a href="https://code.djangoproject.com/ticket/29898">open issue</a> for years.
It was even an <a href="https://gist.github.com/aryan9600/b1c2eaf445006c17e02e7677cf1098d5">Google Summer of Code proposal</a>.</p>
<p>For small projects, it take some seconds to run all your migrations and it is fine. A few developers
can work on it for a long time. For a large project, it is not that simple.</p>
<p>Our largest project today has 273 Django models and did ~1000 migrations in 4 years. Sometimes it
takes 15 minutes on CI, even with a lot of optimizations. Django <code>squashmigrations</code> command do
optimizations, but could be a lot better. After a lot of squashes, it's still slow.</p>
<p>It was really bad for us, CI failed a lot because of timeouts or random postgres failures after
some time trying to always migrate.</p>
<p>We tried some things to improve our CI pipeline.</p>
<h2>Do not migrate on CI</h2>
<p>A common advice to improve this time is to not run migrations on CI. It is fast.</p>
<p>You can override the <a href="https://docs.djangoproject.com/en/4.1/ref/settings/#std-setting-MIGRATION_MODULES"><code>MIGRATIONS_MODULES</code></a> for testing:</p>
<div class="highlight"><pre><span></span><code><span class="n">MIGRATION_MODULES</span> <span class="o">=</span> <span class="p">{</span><span class="n">app</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">INSTALLED_APPS</span><span class="p">}</span>
</code></pre></div>

<p>It is not really safe, because now you run migrations only on deployments, which is risky.
Large projects have data migrations, migration bugs and other issues that you want to discover
before production. So we added another stage to run migrations and our problem was back.</p>
<h2>Reuse database</h2>
<p>In the past <a href="/2021/03/faster-parallel-pytest-django.html">I had to hack pytest-django setup to run less migrations</a>.
This was useful to know how to separate migrations and test steps.</p>
<p>I changed our pipeline to dump the migrated database to a SQL file and cached it on GitLab CI.</p>
<p>Some old code examples from our CI:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Don&#39;t try to copy it, please!</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="nv">$CI_PROJECT_DIR</span>/djangomigrations.sql<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>psql<span class="w"> </span>-h<span class="w"> </span><span class="nv">$DB_HOST</span><span class="w"> </span>-U<span class="w"> </span><span class="nv">$POSTGRES_USER</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;CREATE DATABASE </span><span class="nv">$DB_NAME</span><span class="s2">;&quot;</span>
<span class="w">    </span>pg_restore<span class="w"> </span>-h<span class="w"> </span><span class="nv">$DB_HOST</span><span class="w"> </span>-U<span class="w"> </span><span class="nv">$POSTGRES_USER</span><span class="w"> </span>-d<span class="w"> </span><span class="nv">$DB_NAME</span><span class="w"> </span><span class="nv">$CI_PROJECT_DIR</span>/djangomigrations.sql
<span class="k">else</span>
<span class="w">    </span><span class="nb">time</span><span class="w"> </span>./manage.py<span class="w"> </span>setup_test_db
<span class="w">    </span>pg_dump<span class="w"> </span>-F<span class="w"> </span>c<span class="w"> </span>-h<span class="w"> </span><span class="nv">$DB_HOST</span><span class="w"> </span>-U<span class="w"> </span><span class="nv">$POSTGRES_USER</span><span class="w"> </span><span class="nv">$DB_NAME</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$CI_PROJECT_DIR</span>/djangomigrations.sql
<span class="k">fi</span>
<span class="nb">time</span><span class="w"> </span>./manage.py<span class="w"> </span>clone_test_db
</code></pre></div>

<p>Commands <code>setup_test_db</code> and <code>clone_test_db</code> were just a few lines of Python code, but I'll not paste it here.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># GitLab CI cache work this way.</span>
<span class="nt">cache</span><span class="p">:</span>
<span class="w">  </span><span class="nt">key</span><span class="p">:</span>
<span class="w">    </span><span class="nt">files</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;requirements.txt&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*/migrations/*.py&quot;</span>
<span class="w">  </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">djangomigrations.sql</span>
<span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</code></pre></div>

<p>Perfect! Running a migration state that already ran in the past, GitLab CI give me an
SQL file with this state and I restore it to my database. It took our database migrations from
minutes to just a few seconds. Works for me!</p>
<h2>django-migrations-ci</h2>
<p>I went to DjangoCon US to <a href="https://2022.djangocon.us/talks/django-from-queryset-to-serialization/">talk about django-qserializer</a>. There I had some conversations about how migrations are slow.
More people had the same issue, so I started <a href="https://github.com/buserbrasil/django-migrations-ci">django-migrations-ci</a>
during sprint days of the event.</p>
<p>Using this module, it is just one extra command to setup your test database:</p>
<div class="highlight"><pre><span></span><code><span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrateci</span>
<span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="o">--</span><span class="n">keepdb</span>
</code></pre></div>

<p>Following my original idea, it started using CI caching to provide a storage layer.</p>
<p>I implemented it to sqlite3, mysql and postgres. Never tried to implement for oracle, but it is easy to add
other databases. Also, I documented how to integrate it with GitHub Actions and GitLab CI.</p>
<h2>Partial caching</h2>
<p>After this initial sprint, I replaced the CI caching with a custom storage, easy to integrate
with anything <a href="https://django-storages.readthedocs.io/en/latest/"><code>django-storages</code></a> support.</p>
<p>I did that to support partial migrations. It was impossible to do it with CI caching, because they don't have
an API to easily choose the cache I want.</p>
<p>When a new migration is added, there is no migration state cached, so all migrations are processed
again. To fix this use case, I wanted to get a previous state, restore from it and run only new
migrations, which is reasonably fast.</p>
<h2>Use it</h2>
<p>Now I can say it is easy to reuse my solution and it really adds value to any project where
your migrations take more than a few seconds.</p>
<p>Install it, configure an external storage and add a command to your CI scripts.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">storages.backends.s3boto3</span> <span class="kn">import</span> <span class="n">S3Boto3Storage</span>

<span class="k">class</span> <span class="nc">MigrateCIStorage</span><span class="p">(</span><span class="n">S3Boto3Storage</span><span class="p">):</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="s2">&quot;mybucket-migrateci-cache&quot;</span>
    <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;us-east-1&quot;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./manage.py<span class="w"> </span>migrateci<span class="w"> </span>--storage-class<span class="w"> </span>path.to.MigrateCIStorage
</code></pre></div>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'notenoughmemory';
        var disqus_identifier = '2023/01/faster-django-migrations-with-django-migrations-ci.html';
        var disqus_url = '../../2023/01/faster-django-migrations-with-django-migrations-ci.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//notenoughmemory.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://ceps.io">ceps.io</a></li>
                            <li><a href="https://www.postmon.com.br">postmon</a></li>
                            <li><a href="https://code.djangoproject.com/query?owner=iurisilvio&or&reporter=iurisilvio&col=id&col=summary&col=owner&col=status&col=reporter&col=type&order=priority">Django contributor</a></li>
                            <li><a href="https://github.com/iurisilvio/bottle-sqlalchemy">bottle-sqlalchemy</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://iurisilv.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/iurisilvio">Twitter</a></li>
                            <li><a href="https://github.com/iurisilvio">GitHub</a></li>
                            <li><a href="http://br.linkedin.com/in/iurisilvio">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33399692-1', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'notenoughmemory';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>